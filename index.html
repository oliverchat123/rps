<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multiplayer Rock Paper Scissors</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 400px;
    margin: auto;
  }
  #game, #resultScreen {
    display: none;
  }
  button {
    margin: 5px;
    padding: 10px 15px;
    font-size: 18px;
  }
  .choiceBtn {
    font-size: 30px;
    width: 80px;
    height: 80px;
  }
</style>
</head>
<body>

<h1>Multiplayer Rock Paper Scissors</h1>

<div id="setup">
  <input id="playerNameInput" placeholder="Your Name" />
  <button id="createBtn">Create Game</button>
  <input id="joinCodeInput" placeholder="Room Code" />
  <button id="joinBtn">Join Game</button>
</div>

<div id="game">
  <p>Room: <span id="roomIdDisplay"></span></p>
  <p>Player 1: <span id="player1Name"></span> Score: <span id="player1Score">0</span></p>
  <p>Player 2: <span id="player2Name"></span> Score: <span id="player2Score">0</span></p>
  <p id="status"></p>

  <div id="choices">
    <button class="choiceBtn" data-choice="rock">ü™®</button>
    <button class="choiceBtn" data-choice="paper">üìÑ</button>
    <button class="choiceBtn" data-choice="scissors">‚úÇÔ∏è</button>
  </div>
</div>

<div id="resultScreen">
  <h2 id="resultText"></h2>
  <p>Player 1 (<span id="resPlayer1Name"></span>): <span id="resPlayer1Score"></span></p>
  <p>Player 2 (<span id="resPlayer2Name"></span>): <span id="resPlayer2Score"></span></p>
  <button id="continueBtn">Continue</button>
  <button id="leaveBtn">Leave Room</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZ6kLwtn3ulk5DMaxxjMZOKp2Lscg2njo",
    authDomain: "rock-paper-scissors-72ad9.firebaseapp.com",
    databaseURL: "https://rock-paper-scissors-72ad9-default-rtdb.firebaseio.com",
    projectId: "rock-paper-scissors-72ad9",
    storageBucket: "rock-paper-scissors-72ad9.firebasestorage.app",
    messagingSenderId: "492191154696",
    appId: "1:492191154696:web:9ff5d928599dd21311c7bd",
    measurementId: "G-LF97H69SB0"
  };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elements
const setupDiv = document.getElementById('setup');
const gameDiv = document.getElementById('game');
const resultDiv = document.getElementById('resultScreen');

const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const playerNameInput = document.getElementById('playerNameInput');
const joinCodeInput = document.getElementById('joinCodeInput');

const roomIdDisplay = document.getElementById('roomIdDisplay');
const player1NameDisplay = document.getElementById('player1Name');
const player2NameDisplay = document.getElementById('player2Name');
const player1ScoreDisplay = document.getElementById('player1Score');
const player2ScoreDisplay = document.getElementById('player2Score');

const statusDisplay = document.getElementById('status');
const choicesDiv = document.getElementById('choices');
const choiceButtons = document.querySelectorAll('.choiceBtn');

const resultText = document.getElementById('resultText');
const resPlayer1Name = document.getElementById('resPlayer1Name');
const resPlayer2Name = document.getElementById('resPlayer2Name');
const resPlayer1Score = document.getElementById('resPlayer1Score');
const resPlayer2Score = document.getElementById('resPlayer2Score');
const continueBtn = document.getElementById('continueBtn');
const leaveBtn = document.getElementById('leaveBtn');

let roomId = "";
let playerId = ""; // 'player1' or 'player2'
let playerName = "";
let opponentName = "";

let gameRef = null;
let unsubscribe = null;

// Create game room
createBtn.onclick = async () => {
  playerName = playerNameInput.value.trim();
  if (!playerName) {
    alert("Enter your name");
    return;
  }
  roomId = Math.random().toString(36).substring(2, 8);
  playerId = 'player1';
  gameRef = ref(db, 'games/' + roomId);

  // Setup initial room data
  await set(gameRef, {
    player1: { name: playerName, choice: null, score: 0 },
    player2: { name: null, choice: null, score: 0 },
    round: 1,
    resultShown: false
  });

  startGame();
};

// Join existing room
joinBtn.onclick = async () => {
  playerName = playerNameInput.value.trim();
  if (!playerName) {
    alert("Enter your name");
    return;
  }
  roomId = joinCodeInput.value.trim().toLowerCase();
  if (roomId.length !== 6) {
    alert("Invalid room code");
    return;
  }
  playerId = 'player2';
  gameRef = ref(db, 'games/' + roomId);

  // Check if room exists and player2 is empty
  const snapshot = await new Promise(resolve => onValue(gameRef, snap => resolve(snap), { onlyOnce: true }));
  const data = snapshot.val();
  if (!data) {
    alert("Room not found");
    return;
  }
  if (data.player2 && data.player2.name) {
    alert("Room is full");
    return;
  }

  // Set player2 name and reset their choice & score if needed
  await update(gameRef, {
    'player2/name': playerName,
    'player2/choice': null,
    'player2/score': data.player2?.score || 0,
    resultShown: false
  });

  startGame();
};

function startGame() {
  setupDiv.style.display = 'none';
  gameDiv.style.display = 'block';
  resultDiv.style.display = 'none';

  roomIdDisplay.textContent = roomId;

  listenForGameChanges();
}

// Listen to realtime DB changes
function listenForGameChanges() {
  if (unsubscribe) unsubscribe();

  unsubscribe = onValue(gameRef, async (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      alert("Game ended");
      resetToSetup();
      return;
    }

    const p1 = data.player1 || {};
    const p2 = data.player2 || {};

    // Update names & scores on screen
    player1NameDisplay.textContent = p1.name || 'Player 1';
    player2NameDisplay.textContent = p2.name || 'Player 2';
    player1ScoreDisplay.textContent = p1.score || 0;
    player2ScoreDisplay.textContent = p2.score || 0;

    // If player2 not joined yet
    if (!p2.name) {
      statusDisplay.textContent = "Waiting for Player 2 to join...";
      disableChoices();
      return;
    }

    // If results screen showing, do nothing else
    if (data.resultShown) {
      showResultScreen(data);
      return;
    }

    opponentName = (playerId === 'player1') ? p2.name : p1.name;

    // Check if both players made choices
    if (p1.choice && p2.choice) {
      // Compute winner & update scores
      const winner = decideWinner(p1.choice, p2.choice);
      let newScores = { player1: p1.score || 0, player2: p2.score || 0 };

      if (winner === 'player1') newScores.player1++;
      else if (winner === 'player2') newScores.player2++;

      // Save new scores and mark result shown
      await update(gameRef, {
        'player1/score': newScores.player1,
        'player2/score': newScores.player2,
        resultShown: true
      });

      showResultScreen({ player1: { ...p1, score: newScores.player1 }, player2: { ...p2, score: newScores.player2 }, winner });
      return;
    }

    // If this player already chose
    if ((playerId === 'player1' && p1.choice) || (playerId === 'player2' && p2.choice)) {
      statusDisplay.textContent = `Waiting for ${opponentName} to choose...`;
      disableChoices();
    } else {
      statusDisplay.textContent = `Your turn! Choose rock, paper, or scissors. Opponent: ${opponentName}`;
      enableChoices();
    }
  });
}

function decideWinner(c1, c2) {
  if (c1 === c2) return 'tie';
  if (
    (c1 === 'rock' && c2 === 'scissors') ||
    (c1 === 'paper' && c2 === 'rock') ||
    (c1 === 'scissors' && c2 === 'paper')
  ) return 'player1';
  return 'player2';
}

function showResultScreen(data) {
  gameDiv.style.display = 'none';
  resultDiv.style.display = 'block';

  const p1 = data.player1;
  const p2 = data.player2;
  const winner = data.winner || decideWinner(p1.choice, p2.choice);

  resPlayer1Name.textContent = p1.name || 'Player 1';
  resPlayer2Name.textContent = p2.name || 'Player 2';
  resPlayer1Score.textContent = p1.score || 0;
  resPlayer2Score.textContent = p2.score || 0;

  if (winner === 'tie') resultText.textContent = "It's a tie!";
  else if ((winner === 'player1' && playerId === 'player1') || (winner === 'player2' && playerId === 'player2')) resultText.textContent = "You Win!";
  else resultText.textContent = "You Lose!";
}

// Enable/Disable choice buttons
function enableChoices() {
  choiceButtons.forEach(btn => {
    btn.disabled = false;
  });
}
function disableChoices() {
  choiceButtons.forEach(btn => {
    btn.disabled = true;
  });
}

// On choice clicked
choiceButtons.forEach(btn => {
  btn.onclick = async () => {
    const choice = btn.getAttribute('data-choice');
    const path = `player1/choice`;
    if (playerId === 'player2') {
      await update(gameRef, { 'player2/choice': choice });
    } else {
      await update(gameRef, { 'player1/choice': choice });
    }
    statusDisplay.textContent = "Choice made. Waiting for opponent...";
    disableChoices();
  };
});

// Continue button resets choices and shows game screen
continueBtn.onclick = async () => {
  await update(gameRef, {
    'player1/choice': null,
    'player2/choice': null,
    resultShown: false
  });
  resultDiv.style.display = 'none';
  gameDiv.style.display = 'block';
  statusDisplay.textContent = `Your turn! Choose rock, paper, or scissors. Opponent: ${opponentName}`;
  enableChoices();
};

// Leave room button removes player from room and resets UI
leaveBtn.onclick = async () => {
  // Remove this player's data from the game
  await update(gameRef, {
    [`${playerId}/name`]: null,
    [`${playerId}/choice`]: null,
    [`${playerId}/score`]: 0
  });

  if (unsubscribe) unsubscribe();

  resetToSetup();
};

function resetToSetup() {
  setupDiv.style.display = 'block';
  gameDiv.style.display = 'none';
  resultDiv.style.display = 'none';

  playerNameInput.value = '';
  joinCodeInput.value = '';

  statusDisplay.textContent = '';
  player1NameDisplay.textContent = '';
  player2NameDisplay.textContent = '';
  player1ScoreDisplay.textContent = '0';
  player2ScoreDisplay.textContent = '0';

  roomIdDisplay.textContent = '';
  playerId = '';
  playerName = '';
  roomId = '';
  opponentName = '';
  gameRef = null;
}
</script>

</body>
</html>
